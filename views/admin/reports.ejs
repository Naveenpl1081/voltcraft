<%- include('../layouts/adminheader') %>   

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<div class="container-fluid px-4">
    <h1 class="mt-4">Royal Oak Sales Report</h1>
    <% if (startDate && endDate) { %>
        <div class="alert alert-info">
            Report Period: <%= startDate %> to <%= endDate %>
        </div>
    <% } %>

    <!-- Summary Cards -->
  
    
        <!-- Summary Cards -->
        <div class="row mt-4">
            <div class="col-xl-3 col-md-6">
                <div class="card bg-primary text-white mb-4">
                    <div class="card-body">
                        <h4 class="mb-0">₹<%= metrics.totalAmount.toFixed(2) %></h4>
                        <div class="small">Total Revenue</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-success text-white mb-4">
                    <div class="card-body">
                        <h4 class="mb-0"><%= metrics.totalOrders %></h4>
                        <div class="small">Total Orders</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-warning text-white mb-4">
                    <div class="card-body">
                        <h4 class="mb-0">₹<%= metrics.avgOrderValue.toFixed(2) %></h4>
                        <div class="small">Average Order Value</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-info text-white mb-4">
                    <div class="card-body">
                        <h4 class="mb-0">₹<%= metrics.totalCouponAmount.toFixed(2) %></h4>
                        <div class="small">Total Discounts</div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Detailed Report Table -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-table me-1"></i>
                Detailed Sales Report
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="myTable" class="table table-bordered table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Order ID</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Payment Method</th>
                                <th>Status</th>
                                <th>Discount</th>
                                <th>Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% report.forEach((order) => { %>
                                <tr>
                                    <td><%= order._id %></td>
                                    <td><%= new Date(order.orderDate).toLocaleDateString() %></td>
                                    <td><%= order.deliveryAddress.fullName %></td>
                                    <td>
                                        <%= order.items.reduce((sum, item) => sum + item.quantity, 0) %>
                                        items
                                    </td>
                                    <td><%= order.paymentMethod %></td>
                                    <td>
                                        <span class="badge bg-<%= getStatusColor(order.orderStatus) %>">
                                            <%= order.orderStatus %>
                                        </span>
                                    </td>
                                    <td>₹<%= order.couponApplied ? getCouponAmount(order) : '0.00' %></td>
                                    <td>₹<%= order.totalAmount.toFixed(2) %></td>
                                </tr>
                            <% }); %>
                        </tbody>
                        <tfoot class="table-dark">
                            <tr>
                                <td colspan="6"><strong>Totals</strong></td>
                                <td>₹<%= metrics.totalCouponAmount.toFixed(2) %></td>
                                <td>₹<%= metrics.totalAmount.toFixed(2) %></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    
        <!-- Export Buttons -->
        <div class="text-center mb-4">
            <button id="download-pdf" class="btn btn-success me-2">
                <i class="fas fa-file-pdf me-1"></i> Download as PDF
            </button>
            <button id="download-excel" class="btn btn-success">
                <i class="fas fa-file-excel me-1"></i> Download as Excel
            </button>
        </div>
    </div>

<script>
// Chart Initialization
// Chart Initialization
document.addEventListener('DOMContentLoaded', function() {
    // Payment Methods Chart
    const paymentMethodCtx = document.getElementById('paymentMethodChart');
    if (paymentMethodCtx) {
        new Chart(paymentMethodCtx, {
            type: 'bar',
            data: {
                labels: <%- JSON.stringify(paymentMethodLabels || []) %>,
                datasets: [{
                    label: 'Number of Orders',
                    data: <%- JSON.stringify(paymentMethodData || []) %>,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // Order Status Chart
    const orderStatusCtx = document.getElementById('orderStatusChart');
    if (orderStatusCtx) {
        new Chart(orderStatusCtx, {
            type: 'pie',
            data: {
                labels: <%- JSON.stringify(orderStatusLabels || []) %>,
                datasets: [{
                    data: <%- JSON.stringify(orderStatusData || []) %>,
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(153, 102, 255, 0.5)',
                        'rgba(255, 159, 64, 0.5)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true
            }
        });
    }
});
// PDF Export
document.getElementById('download-pdf').addEventListener('click', function() {
    const element = document.querySelector('.card-body');
    const opt = {
        margin: 1,
        filename: 'sales_report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
    };
    html2pdf().from(element).set(opt).save();
});

// Excel Export
document.getElementById('download-excel').addEventListener('click', function() {
    const table = document.getElementById('myTable');
    const wb = XLSX.utils.table_to_book(table);
    XLSX.writeFile(wb, 'sales_report.xlsx');
});
</script>

<style>
.table th, .table td {
    vertical-align: middle;
}
.badge {
    font-size: 0.9em;
    padding: 0.5em 0.75em;
}
.card {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(33, 40, 50, 0.15);
}
</style>

<%- include('../layouts/adminfooter') %>